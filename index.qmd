---
title: CRAN deadlines
---

```{r}
#| echo: false
library(dplyr, warn.conflicts = FALSE)
library(glue)
library(reactable)

cran_db <- as_tibble(tools::CRAN_package_db())
cran_results <- as_tibble(tools::CRAN_check_results())

recursive_revdeps <- function(pkgs) {
  tools::package_dependencies(pkgs, reverse = TRUE, recursive = TRUE)
}

has_deadline <- cran_db |> 
  filter(!is.na(Deadline)) |> 
  select(Package, Deadline, Maintainer) |> 
  mutate(
    Deadline = as.Date(Deadline),
    Maintainer = gsub(" <.*?>", "", Maintainer),
    Dependencies = lengths(recursive_revdeps(Package))
  ) |>
  arrange(Deadline)

```

There are currently `r nrow(has_deadline)` packages at risk for removal from CRAN if not fixed by the specified deadline:

```{r}
#| echo: false
has_deadline |>
  mutate(
    Package = glue("<a href='#{Package}'>{Package}</a>")
  ) |>
  reactable(
    filterable = TRUE, 
    columns = list(Package = colDef(html = TRUE)),
    defaultPageSize = 25
  )
```

(Source code for this file can be found at <https://github.com/hadley/cran-deadlines>)

## Details

```{r}
#| echo: false
#| results: asis

status_factor <- function(x) {
  factor(x, c("FAILURE", "ERROR", "WARNING", "NOTE"))
}

cran_checks <- as_tibble(tools::CRAN_check_details())

problem_summaries <- cran_checks |>
  filter(Status != "OK") |>
  semi_join(has_deadline, join_by(Package)) |>
  distinct(Package, Status, Check) |>
  mutate(
    bullet = glue("* **{Status}**: {Check} "), 
    Status = status_factor(Status),
  ) |>
  arrange(Package, Status) |>
  summarise(bullets = glue_collapse(bullet, "\n"), .by = Package)
# problem_summaries 
  # |>
  # summarise(Flavour = paste0(Flavor, collapse = ", "), .by = ) |>
  # summarise(problems = , .by = Package)

problems <- cran_results |> 
  select(-Maintainer, -Flags, -starts_with("T_"), -Priority) |> 
  filter(Status != "OK") |> 
  semi_join(has_deadline, join_by(Package)) |> 
  relocate(Package) |> 
  mutate(Status = status_factor(Status)) |>
  arrange(tolower(Package), Status)

problem_summary <- function(package, version, flavor, status, problems) {
  url <- glue("https://www.r-project.org/nosvn/R.check/{flavor}/{package}-00check.html")
  paste0(
    glue("### {package} {version} {{#{package}}}"), "\n",
    glue("[CRAN Package Check Results](https://cran.r-project.org/web/checks/check_results_{package}.html)"), "\n\n",
    "\n",
    "Problems: \n\n",
    problems,
    "\n", "\n",
    "<details><summary>Checks</summary>\n",
    paste0(glue("* [{flavor}]({url}): {status}"), "\n", collapse = ""),
    "</details>",
    "\n"
  )
}

problems |>
  left_join(problem_summaries, join_by(Package)) |>
  summarise(
    problem_summary(Package[1], Version[1], Flavor, Status, bullets[1]), 
    .by = Package
  ) |>
  pull() |>
  writeLines()
```
